services:
  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: ai-assistant-mqtt
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    volumes:
      - ./mqtt/config:/mosquitto/config:ro
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    environment:
      - MQTT_MAX_CONNECTIONS=${MQTT_MAX_CONNECTIONS:-100}
      - MQTT_MAX_QUEUED_MESSAGES=${MQTT_MAX_QUEUED_MESSAGES:-1000}
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai-assistant-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: ai-assistant-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-ai_assistant}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ai_assistant_secret}
      - POSTGRES_DB=${POSTGRES_DB:-ai_assistant}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ai_assistant} -d ${POSTGRES_DB:-ai_assistant}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  memory-service:
    build:
      context: .
      dockerfile: services/memory/Dockerfile
    container_name: ai-assistant-memory
    restart: unless-stopped
    ports:
      - "${MEMORY_HTTP_PORT:-8080}:8080"
    environment:
      # Database connections (use container names as hosts)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-ai_assistant}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ai_assistant_secret}
      - POSTGRES_DB=${POSTGRES_DB:-ai_assistant}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      # MQTT connection
      - MQTT_HOST=mqtt-broker
      - MQTT_PORT=1883
      # Ollama connection (external service)
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      # Memory service settings
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - COMPACTION_MODEL=${COMPACTION_MODEL:-qwen3:1.7b}
      - COMPACTION_THRESHOLD=${COMPACTION_THRESHOLD:-20}
      - COMPACTION_KEEP_RECENT=${COMPACTION_KEEP_RECENT:-5}
      - AUTO_LOG_CONVERSATIONS=${AUTO_LOG_CONVERSATIONS:-true}
      - AUTO_COMPACT=${AUTO_COMPACT:-true}
      - HTTP_PORT=8080
      - HTTP_HOST=0.0.0.0
      - DEBUG=${DEBUG:-false}
    depends_on:
      mqtt-broker:
        condition: service_healthy
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  mqtt-data:
    driver: local
  mqtt-logs:
    driver: local
  qdrant-data:
    driver: local
  postgres-data:
    driver: local
